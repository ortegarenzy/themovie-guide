
/*
 * This file is part of Jkop
 * Copyright (c) 2016-2018 Job and Esther Technologies Oy
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */

"use strict";var CapexWebJSONAPIClient = function() {this.apiUrl = null;this.webClient = null;};var P = CapexWebJSONAPIClient.prototype;P._t = {"CapexWebJSONAPIClient" : true};CapexWebJSONAPIClient.IS_INSTANCE = function(o) {return(o != null && o._t != null && o._t["CapexWebJSONAPIClient"] === true);};CapexWebJSONAPIClient.NEW = function() {var v = new CapexWebJSONAPIClient();return(v.CTOR());};P.CTOR = function() {this.webClient = null;this.apiUrl = null;return(this);};P.getFullURL = function(api) {var url = this.apiUrl;if(CapeString.isEmpty(url)) {url = "/";}if(url === "/") {if(CapeString.startsWithWithStringAndStringAndSignedInteger(api, "/", 0)) {return(api);}return(url + api);}if(CapeString.endsWithWithStringAndString(url, "/")) {if(CapeString.startsWithWithStringAndStringAndSignedInteger(api, "/", 0)) {return(url + (CapeString.getSubStringWithStringAndSignedInteger(api, 1)));}return(url + api);}if(CapeString.startsWithWithStringAndStringAndSignedInteger(api, "/", 0)) {return(url + api);}return(url + "/" + api);};P.toUTF8Buffer = function(data) {if(!(data != null)) {return(null);}return(CapeString.toUTF8Buffer(CapeJSONEncoder.encode(data, true)));};P.customizeRequestHeaders = function(headers) {};P.onStartSendRequest = function() {};P.onEndSendRequest = function() {};P.onDefaultErrorHandler = function(error) {};P.handleAsError = function(response, callback) {var error = this.toError(response);if(error != null) {this.onErrorWithErrorAndFunctionVoidCapeError(error, callback);return(true);}return(false);};P.toError = function(response) {if(!(response != null)) {return(CapeError.forCode("noServerResponse", null));}if(response.getString("status", null) === "error") {var v = CapeError.NEW();v.setCode(response.getString("code", null));v.setMessage(response.getString("message", null));v.setDetail(response.getString("detail", null));return(v);}return(null);};P.onErrorWithErrorAndFunctionVoidCapeError = function(error, callback) {if(!(callback != null)) {this.onDefaultErrorHandler(error);return;}callback(error);};P.onErrorWithError = function(error) {this.onErrorWithErrorAndFunctionVoidCapeError(error, null);};P.sendRequest = function(method, url, headers, data, callback, errorCallback) {if(!(callback != null)) {return;}var ll = callback;var ecb = errorCallback;this.doSendRequest(method, url, headers, data, function(responseHeaders, body){if(!(body != null)) {this.onErrorWithErrorAndFunctionVoidCapeError(CapeError.forCode("failedToConnect", null), ecb);return;}var tjsonResponseBody = CapeJSONParser.parseString(CapeString.forUTF8Buffer(body));var jsonResponseBody = null;if(CapeDynamicMap.IS_INSTANCE(tjsonResponseBody)) {jsonResponseBody = tjsonResponseBody;}if(!(jsonResponseBody != null)) {this.onErrorWithErrorAndFunctionVoidCapeError(CapeError.forCode("invalidServerResponse", null), ecb);return;}if(!this.handleAsError(jsonResponseBody, ecb)) {ll(jsonResponseBody);}}.bind(this), ecb);};P.doSendRequest = function(method, url, headers, data, callback, errorCallback) {if(!(callback != null)) {return;}var hrs = headers;if(!(hrs != null)) {hrs = CapeKeyValueList.NEW();hrs.addKAndV("Content-Type", "application/json");}if(!(this.webClient != null)) {this.webClient = CapexWebNativeWebClient.instance();}if(!(this.webClient != null)) {this.onErrorWithErrorAndFunctionVoidCapeError(CapeError.forCode("noWebClient", null), errorCallback);return;}var ll = callback;this.customizeRequestHeaders(hrs);this.onStartSendRequest();var ecb = errorCallback;this.webClient.query(method, url, hrs, data, function(status, responseHeaders, body){this.onEndSendRequest();if(!(body != null)) {this.onErrorWithErrorAndFunctionVoidCapeError(CapeError.forCode("failedToConnect", null), ecb);return;}ll(responseHeaders, body);}.bind(this));};P.doGetFile = function(url, callback, errorCallback) {this.doSendRequest("GET", this.getFullURL(url), null, null, callback, errorCallback);};P.doGet = function(url, callback, errorCallback) {this.sendRequest("GET", this.getFullURL(url), null, null, callback, errorCallback);};P.doPost = function(url, data, callback, errorCallback) {this.sendRequest("POST", this.getFullURL(url), null, this.toUTF8Buffer(data), callback, errorCallback);};P.doPut = function(url, data, callback, errorCallback) {this.sendRequest("PUT", this.getFullURL(url), null, this.toUTF8Buffer(data), callback, errorCallback);};P.doDelete = function(url, callback, errorCallback) {this.sendRequest("DELETE", this.getFullURL(url), null, null, callback, errorCallback);};P.uploadFile = function(url, data, mimeType, callback, errorCallback) {var mt = mimeType;if(CapeString.isEmpty(mt)) {mt = "application/octet-stream";}var hdrs = CapeKeyValueList.NEW();hdrs.addKAndV("content-type", mt);this.sendRequest("POST", this.getFullURL(url), hdrs, data, callback, errorCallback);};P.getWithStatus = function(url, callback) {var cb = callback;var okcb = function(v){var data = v.getDynamicMap("data");if(data == null) {data = CapeDynamicMap.NEW();}cb(data, null);}.bind(this);var errcb = function(err){cb(null, err);}.bind(this);this.sendRequest("GET", this.getFullURL(url), null, null, okcb, errcb);};P.postWithStatus = function(url, data, callback) {var cb = callback;var okcb = function(v){var data = v.getDynamicMap("data");if(data == null) {data = CapeDynamicMap.NEW();}cb(data, null);}.bind(this);var errcb = function(err){cb(null, err);}.bind(this);this.sendRequest("POST", this.getFullURL(url), null, this.toUTF8Buffer(data), okcb, errcb);};P.getApiUrl = function() {return(this.apiUrl);};P.setApiUrl = function(v) {this.apiUrl = v;return(this);};P.getWebClient = function() {return(this.webClient);};P.setWebClient = function(v) {this.webClient = v;return(this);};var CapexWebNativeWebClient = function() {};var P = CapexWebNativeWebClient.prototype;P._t = {"CapexWebNativeWebClient" : true};CapexWebNativeWebClient.IS_INSTANCE = function(o) {return(o != null && o._t != null && o._t["CapexWebNativeWebClient"] === true);};CapexWebNativeWebClient.NEW = function() {var v = new CapexWebNativeWebClient();return(v.CTOR());};P.CTOR = function() {return(this);};CapexWebNativeWebClient.instance = function() {return(CapexWebWebClientForJavaScript.NEW());};var CapexWebWebClient = {};CapexWebWebClient.IS_INSTANCE = function(o) {return(o != null && o._t != null && o._t["CapexWebWebClient"] === true);};var CapexWebWebClientForJavaScript = function() {};var P = CapexWebWebClientForJavaScript.prototype;P._t = {"CapexWebWebClientForJavaScript" : true,"CapexWebWebClient" : true};CapexWebWebClientForJavaScript.IS_INSTANCE = function(o) {return(o != null && o._t != null && o._t["CapexWebWebClientForJavaScript"] === true);};CapexWebWebClientForJavaScript.NEW = function() {var v = new CapexWebWebClientForJavaScript();return(v.CTOR());};P.CTOR = function() {return(this);};P.query = function(method, url, requestHeaders, body, callback) {if(CapeString.isEmpty(method) || CapeString.isEmpty(url)) {callback(null, null, null);return;}if(CapeString.startsWithWithStringAndStringAndSignedInteger(url, "/", 0) === false && CapeString.startsWithWithStringAndStringAndSignedInteger(url, "http://", 0) === false && CapeString.startsWithWithStringAndStringAndSignedInteger(url, "https://", 0) === false) {callback(null, null, null);return;}this.send(method, url, requestHeaders, body, callback);};P.getXMLHttpRequestObject = function() {var xhr = null;if(typeof XMLHttpRequest === "undefined") {XMLHttpRequest = function() {try {return new ActiveXObject('Msxml2.XMLHTTP.6.0');}catch(e) {}try {return new ActiveXObject('Msxml2.XMLHTTP.3.0');}catch(e) {}try {return new ActiveXObject('Microsoft.XMLHTTP');}catch(e) {}throw new Error('This browser does not support XMLHttpRequest.');}}xhr = new XMLHttpRequest();return(xhr);};P.onResponseReceived = function(status, responseHeaders, body, callback) {var nhdrs = CapeKeyValueList.NEW();var hdrs = CapeString.split(responseHeaders, ';', 0);if(hdrs != null) {var i = 0;for(i = 0 ; i < CapeVector.getSize(hdrs) ; i++) {var ts = CapeVector.get(hdrs, i);var s = null;if(typeof(ts) === 'string') {s = ts;}if(CapeString.isEmpty(s) === false) {var ss = CapeString.split(s, ':', 0);if(ss != null) {var tk = CapeVector.get(ss, 0);var k = null;if(typeof(tk) === 'string') {k = tk;}var tv = CapeVector.get(ss, 1);var v = null;if(typeof(tv) === 'string') {v = tv;}if(CapeString.isEmpty(k) || CapeString.isEmpty(v)) {continue;}nhdrs.addKAndV(k, v);}}}}callback(status, nhdrs, body);};P.send = function(method, url, requestHeaders, body, callback) {var xhr = this.getXMLHttpRequestObject();xhr.open(method, url, true);xhr.responseType = "arraybuffer";xhr.onreadystatechange = function() {if(xhr.readyState == 4) {this.onResponseReceived(""+xhr.status, xhr.getAllResponseHeaders(), xhr.response, callback);}}.bind(this);if(requestHeaders != null) {var iter = requestHeaders.iterate();while(true) {var tkv = iter.next();var kv = null;if(CapeKeyValuePair.IS_INSTANCE(tkv)) {kv = tkv;}if(kv == null) {break;}var k = kv.key;var v = kv.value;xhr.setRequestHeader(k, v);}}if(body != null) {xhr.send(new Uint8Array(body));}else {xhr.send();}};